{% extends 'boards/base.html' %}
{% block content %}
{% include 'friends/navbar.html' %}
<div class="flex items-center justify-center w-full ">
	<div class="w-full overflow-hidden bg-white rounded-md">
		<div class="flex items-center justify-between px-4 py-2 font-normal text-black border-b border-gray-300">
			<div class="flex items-center">
				{% if user.user_img %}
					<img src="{{ user.user_img.url }}" alt="" class="w-12 h-12 mr-2 rounded-full">
				{% else %}	
					<img src="https://via.placeholder.com/32" alt="Profile Picture" class="w-12 h-12 mr-2 rounded-full">
				{% endif %}
				<div>
					<h2 class="text-lg">{{ user.name }}</h2>
					<p class="text-sm text-gray-500">{{ user.username }}</p>
				</div>
			</div>
			<div x-data="{ showDropdown: false }">
				<button @click="showDropdown = !showDropdown" class="focus:outline-none">
					<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
						stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
					</svg>
				</button>
				<div x-show="showDropdown" @click.away="showDropdown = false"
					class="absolute py-2 mt-2 bg-white rounded-md shadow-md">
					<a href="#"
						class="inline-block px-2 py-1 text-sm font-light text-red-600 hover:text-red-800">刪除好友</a>
				</div>
			</div>
		</div>
		<div class="flex-1 p-2 border-t border-b border-gray-300">
			<div id="chat-log" class="overflow-y-auto rounded-md h-80">qwe</div>
		</div>
		<div class="flex h-20 p-4">
			<input type="text" id="chat-message-userId" value="{{ user.id }}" hidden>
			<input id="chat-message-input" type="text" placeholder="輸入訊息..."
				class="flex-1 px-2 rounded-md focus:outline-none">
			<button id="chat-message-submit"
				class="bg-[#3397cf] text-white font-light px-4 rounded-md hover:bg-sky-400">送出</button>
		</div>
	</div>
	{{ room_name|json_script:"room-name" }}
</div>
<script>
	document.addEventListener('DOMContentLoaded', (event) => {
		const roomName = JSON.parse(document.getElementById('room-name').textContent);

		const chatSocket = new WebSocket(
			'ws://'
			+ window.location.host
			+ '/ws/chat/'
			+ roomName
			+ '/'
		);

		chatSocket.onmessage = function (e) {
			const data = JSON.parse(e.data);
			const chatLog = document.querySelector('#chat-log');
			const messageElement = document.createElement('div');
			messageElement.classList.add('p-2', 'border-b', 'border-gray-200', 'bg-white', 'rounded-md', 'mb-2', 'shadow-sm');
			messageElement.textContent = data.content;
			console.log("data", data)
			chatLog.appendChild(messageElement);
			chatLog.scrollTop = chatLog.scrollHeight;
		};

		chatSocket.onclose = function (e) {
			console.error('Chat socket closed unexpectedly');
		};

		const messageInputDom = document.querySelector('#chat-message-input');
		const messageSubmitDom = document.querySelector('#chat-message-submit');
		const userId = document.querySelector("#chat-message-userId").value;

		messageInputDom.focus();
		messageInputDom.onkeyup = function (e) {
			if (e.key === 'Enter') {
				messageSubmitDom.click();
			}
		};

		messageSubmitDom.onclick = function (e) {
			const message = messageInputDom.value;
			const privateUsers = roomName.split("_");
			const receiverId = privateUsers[0] == userId ? privateUsers[1] : privateUsers[0];

			chatSocket.send(JSON.stringify({
				"senderId": userId,
				"receiverId": receiverId,
				"message": message
			}));

			messageInputDom.value = '';
		};
	});
</script>
{% endblock %}